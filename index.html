<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PFP Generator Preview</title>

  <style>
    body {
      margin: 0;
      padding: 40px;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }

    button {
      padding: 14px 24px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
    }

    canvas {
      display: block;
      margin: 30px auto;
      width: 640px;
      height: 640px;
      border-radius: 12px;
      background: #222;
    }
  </style>
</head>

<body>

  <button id="generate">Generate</button>
  <canvas id="canvas" width="2024" height="2024"></canvas>

<script>
/* ==========================
   CONFIG — CHANGE ONLY THESE
========================== */

const GITHUB_USERNAME = "daresum";
const GITHUB_REPO = "PFPGen";
const GITHUB_BRANCH = "main";

/* ==========================
   DO NOT CHANGE BELOW
========================== */

const CDN_BASE = `https://cdn.jsdelivr.net/gh/daresum/PFPGen/layers`;

/* Layer order = draw order */
const LAYERS = [
  { name: "background", files: ["blue.png", "green.png", "pink.png"] },
  { name: "base", files: ["base.png"], fixed: true },
  { name: "body", files: ["artist.png", "broken.png", "built.png", "coat.png", "hands.png", "show.png", "turtleneck.png", "tux.png", "zombie.png"] },
  { name: "head", files: ["cap.png", "wizard.png", "afro.png", "blonde.png", "cowboy.png", "hair.png", "ketchup.png", "punk.png", "vampire.png", "wizard.png" ] },
  { name: "mouth", files: ["baby.png", "braces.png", "bro.png", "bunny.png", "car.png", 
  "cheer.png", "chew.png", "chin.png", "clown.png", "cute.png", "cutesmile.png", 
  "drool.png", "feef.png", "fishlips.png", "flabergasted.png", "froglip.png", "frown.png", 
  "gb.png", "grind.png", "hm.png", "laugh.png", "line.png", "lips.png", "lipstick.png",
  "lipsy.png"] },
  { name: "eyes", files: ["anime.png", "blank.png", "buttons.png", "cool.png",  
  "cyclop.png", "eyepatch.png", "fury.png", "glasses.png", "googly.png", 
  "happy.png", "heavy.png", "holes.png", "jaded.png", "laser.png", "mad.png", 
  "nerd.png", "note.png", "paranoid.png", "pepe.png", "pure.png", "ruleone.png", 
  "sleep.png", "sunglasses.png", "surprised.png", "sus.png", "swirl.png",
  "tear.png", "third-eye.png", "thug.png", "tired.png", "wink.png", "x.png", "yes.png" ] }
];

/* ==========================
   EXCLUSIONS — EDIT HERE
========================== */

const EXCLUSIONS = [
  {
    if: { eyes: "agent.png" },
    notAllowed: { head: ["afro.png"] }
  },
  {
    if: { head: "cap.png" },
    notAllowed: { eyes: ["googly.png"] }
  }
];

/* ==========================
   HELPER FUNCTIONS
========================== */


function randomItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = () => reject(`Failed to load ${src}`);
    img.src = src;
  });
}

function violatesExclusion(selection) {
  for (const rule of EXCLUSIONS) {
    // Check if all conditions in "if" match
    let ifMatches = true;
    for (const [layer, file] of Object.entries(rule.if)) {
      if (selection[layer] !== file) {
        ifMatches = false;
        break;
      }
    }
    if (!ifMatches) continue;

    // If "if" matches, check if any notAllowed files are in the selection
    for (const [layer, bannedFiles] of Object.entries(rule.notAllowed)) {
      if (bannedFiles.includes(selection[layer])) {
        return true; // invalid combination
      }
    }
  }

  return false; // no exclusions violated
}

/* ==========================
   GENERATE PFP
========================== */

async function generatePFP() {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  let selection = {};

  // Repeat until selection does NOT violate exclusions
  do {
    selection = {};
    for (const layer of LAYERS) {
      const file = layer.fixed
        ? layer.files[0]
        : randomItem(layer.files);

      selection[layer.name] = file;
    }
  } while (violatesExclusion(selection));

  // Draw final selection
  for (const layer of LAYERS) {
    const file = selection[layer.name];
    const img = await loadImage(`${CDN_BASE}/${layer.name}/${file}`);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }
}

/* ==========================
   UI
========================== */

document.getElementById("generate").addEventListener("click", generatePFP);
</script>

</body>
</html>
